name: QuantClaw Data CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-modules:
    name: ðŸ§ª Test Python Modules
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install yfinance numpy scipy pandas statsmodels pandas-datareader requests beautifulsoup4
          pip install pytest

      - name: Test all module imports
        run: |
          echo "Testing all module imports..."
          FAILED=0
          for f in modules/*.py; do
            MOD=$(basename "$f" .py)
            if [ "$MOD" = "__init__" ]; then continue; fi
            python -c "import modules.$MOD" 2>/dev/null && echo "âœ… $MOD" || { echo "âŒ $MOD"; FAILED=$((FAILED+1)); }
          done
          echo "---"
          echo "Failed imports: $FAILED"
          if [ $FAILED -gt 5 ]; then echo "Too many failures"; exit 1; fi

      - name: Run data integrity tests
        run: python tests/test_data_integrity.py || true
        continue-on-error: true

  build-nextjs:
    name: ðŸ—ï¸ Build Next.js
    runs-on: ubuntu-latest
    needs: test-modules
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: NODE_OPTIONS="--max-old-space-size=2048" npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

  count-stats:
    name: ðŸ“Š Project Stats
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Count stats
        run: |
          echo "## ðŸ“Š QuantClaw Data Stats" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          MODULES=$(ls modules/*.py 2>/dev/null | grep -v __init__ | wc -l)
          ROUTES=$(find src/app/api/v1 -name "route.ts" 2>/dev/null | wc -l)
          PYLINES=$(find modules -name "*.py" | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}')
          TSLINES=$(find src -name "*.ts" -o -name "*.tsx" | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}')
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python modules | $MODULES |" >> $GITHUB_STEP_SUMMARY
          echo "| API routes | $ROUTES |" >> $GITHUB_STEP_SUMMARY
          echo "| Python LOC | $PYLINES |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript LOC | $TSLINES |" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [test-modules, build-nextjs]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: 76.13.147.35
          username: quant
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/quant/apps/quantclaw-data
            git pull origin main
            npm ci
            NODE_OPTIONS="--max-old-space-size=2048" npm run build
            pm2 restart quantclaw-data
            echo "âœ… Deployed $(date)"
